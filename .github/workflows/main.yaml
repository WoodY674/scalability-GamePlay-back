name: üí´ Vercel Production Deployment

on:
  pull_request:
    types:
      - closed

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  DOCKER_IMAGE_NAME_TEST: anthlr/scalabilite-gameplay-back:$GITHUB_RUN_ID
  DOCKER_IMAGE_NAME_LATEST: anthlr/scalabilite-gameplay-back:latest
  NEXT_PUBLIC_PRIV_KEY_FAKE: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS0FJQkFBS0NBZ0VBeDNpL2RqWXRJRGluVkNmZmxtUzBLYVdBSWUxNjFUUVlOeTFIbHJSampmOTNJSWJEClNReXluc0lsMkt1TDJlWHp4ZmhaTHdtb053NlNQbng4a2cvUHB4blJZNzYxUXhJeEJiTnZvcko3YWJZamYxYmoKbWdUT21IK2I1M20raERMbmFhMUNtdUgyQUlRbDJycEpacE9iWndFcC9LQStUWHdhMDlVOC8yaWJKZDdHM0l4RQowS2J6WkRWcHc4d1VoUGp1TUFIQVVnQ1Z6dmJYemozdjFtenVOQklTcE5EVW1oZFk4dDNhTTA0S1dCY1hWcC92CnF0QU15RWNaVU1zaStYSnhUNmRWaFdiM2J1eDJDTk5RZS9LYlMyekw1OHBnZnVqQmY4L0YyczN0WWQrWlh5YlEKUlhDM0RSLzNUQmtjSC81NGl6VEZJVG1KQ0l5eFJHWWIwK09DWnpNeXRaUy93SXllRDZObjRvSjk3VUZUcGlGOApmR0E2ZTcvZWExS290WkdDVUlKUHRYTGdMOENFTWxIcHRNN081MmRZcmp6b3NSV20xK20zbDNrV09zTDdod08wCllDZWVaRS80Q3FwS2Q1RmRzZjZRT0NHVjF0ZDZQZ1V4NTd2OHRoM3Y5Y085VmRRTUkwT0MwOWRVc2VUdmN4bDIKNzFGdy9IZ1UwSStCazg3aE9xR09HMW9VSTJDbTRBZ0FqZWJwaUZnUW9pWGdHcjY5Mjlxb3lnUFlBT3I5RVBRWQovdWFFK0Z0SWVRbFNDK2ZabTVHTjB6VGs1ZWFhQXVvZFB4T0JGU2x1S3hja2xuMHFzbXF1aC9WR1FZVHBrRm9UCkdOTHJ2YW83N1E4YTN0OE11UDliTmN2WUF5VlhCQU1ZcmZxQ3lqa1hCRzdZb1htUldtWCtaTFlGQy9VQ0F3RUEKQVFLQ0FnQUxGb2cyRHY3bEtxRUtpWWpoT0VuWGdzNmpsQ3JlelIySGU2bmVFN3J3K3NGcGVuUkNqRVVsbEE4OApneFNzRVI5QzR2STZMaVErb3oyMzRYMmZOT2ZMRnlGUGxSdElWaXVKY0pjRkNUelkvSG51cXlyTnRmU3gvMjN3CktSRlJFZTlSTFlObFRxZzVFUjkxa0NOaVkxUWhIcXh4MFlxRkRpQURwSGZXanI4SkZPQWpCRjBTNkNUaGJpS3AKOHA4MVlRMEVlQ1J6cW5xcFhZbFRlcGZwYUhhNVNFUG5DNEMxN0JSU3M4aGNUN3M5ZUZNZ3lwVXMvcEduVkdSdwozRW5lYWVFb2wxbW1wN21iWGVPVnpBRk9Vb2NWWXovV2E2Wi9oM3F5R3grWmNSYi8rTWp5eEJxUnNabExUbnFWCnJWT2w1NlJWd0tJd25aMGpiNGF2RWFuOFZrbzZUeWY5Uzhnb1ZBbFFaZmhJRjNNVnd5eDJzWmFuWlVVcTliY2cKNzVZN3owQ2VFUFJlK0FJenBnc080cTZoL2pmV3NYYnAzdkdHWE5wVkpxdGdxc0NnWWlveXpZc2xRRjNPS3BjcQp0NnNwK2dzVEV1NXgzc3I3M0NaaFYrdjlRVTlFUEJmZlFYdTh2b1VnQlV4U2x6UDUwRXZweXVQZWRVbmRoRzV6CmJuRCtIckRjaGs1UXIvQ3Z6TmFwakNuUzdDOU9CRGhDeStQbjRUaVl3S0ZpSFRrWG5rMlVONzh3TDlMZEZtbWsKeGJHclA4clhkMy94a2ZyS0s5REZKTkplTkVmTS9aTEplVmtOMFNpaFJPbW44OWRZYVczVEJ6dHd3UEljeVF2agpBd2VPN1QzK3Y1YmhsUGFwVVc1dHFHUW1lckdnUyt6NldPQkpzc0lvaSsvZ0RmQTJ3UUtDQVFFQTlHdmt3bXBCClFlRXAwU2p6L0xYZnpWV09TZGVyOHZJN2RrUmQwcG1pY1Nodm42Q05LbUhwVWlGZUx6UDJPQnlreXN5ajhkRGgKTFpMSTdvbEdROUhmZUlKaXR1Z1p1WWR5eW5Xd0tqRHJTZEJjL3dSa0JJaU5haGRaTmNsY0tnWVJqM0R1aklSaQpZTVlKMFJ0MnhqYVQ0NEl4RnhPYkIwUERLU0oxaWFqcU85L0liSFdXbEl6ak5IaElDOTlKQnZZd0haZVkxN1JFCjNDYy9yR3ZTUGNvOTZ6VmoxZnozVjd2VWJycGlBbkVKQUFBdFptT290dWJMMmRLVWZVZisrUnU4VjlYVkp2MUkKRUJZM2R1UGZtMG9ORGt1WHZ1Y1dzUURQNi9vTkhUVjJIVElMWlk1cytWOWNGbHJTdDlQVlduWXdqUVV3WFgxYQo1cklqaU5XWTNOS3FKUUtDQVFFQTBPdS9NeEQ1ZXh3bjIxVllGdk5UTnZzVXJTemNoTnFjYkFkWmplUDRZNUkyCnlhTUJkMnc5UjFYblZvaTVIakV0WGo1ZHlVWDFpN0ZCazZJcjlIU3hxMmhIWWp3RmlJSUFDanFubVozbEJLWlgKTFIyNkJxVTlIczQ3L3dkOHlzYlIyMHUwalJoVU1rZ1phc3BRWVluN3NaNEZLdlZtVnFtTVdVZGszbExsVTlVbwo1dmIvM3FqSjNrblUvalpHTlppS0ZhR0RBV0tYNVlHWnhvSHNJdDVFNTJHKzM1di93YnFycTI2WVg1bm1lOFBXCnRZQStkR2tMZGd6YzJjbmRVMkxNVWJkU2ZEMENQSStpK0JWZHNCNE80a0crRU5nYTEweHFITys1Rnl1ZEg2d28KclFLWndFRDZRUGRXYVFIaTVWUnJMd2x5Wm5zMWZwTE90dWJoeVV2cGtRS0NBUUJxWVh0VFVzUE1WSi9LdFRSYwpUUngzVmtGenlqYkFxc1ZPbURydHFvaVZEN0Jsblk5VFh3SWFDUVBoTDVCK281amwyMk9Qb0FZaHU3MVFkTmJzCk5iQTUxeVgzemRWRWRydHpldjJObjNVSXozTnFXeExkRmtIV1p3c2c2ZDcvTzF6eFBZbldCdGg2bmpjdmwvQisKSE1zSlBtVDNVa1VyU0ViczVGNmI1N1RyRWw4OU5ZQ3dieEdFaU1WeXhXQVhjNWRGaWZHd0VIbllDQTBpa2xzVApJYThKYkZkamo1Sm4wUXlJbFA2TGFYOHRUT1oxcGZLTWlLODR3dnAxL0p2dytDMWxYV0JFZEFDbFg4WU1MT25wCndMVWwvNml3SWd3eVJkUTVOTC80Y29oUjlMSVpKWUF3bVZ5UExrQ0FXZWFHVk9LVXZpbHF4MkNGQUF1UFJzZ2QKZEdNeEFvSUJBQUpkaU82bEZJNEdSWlZBSkIwdWFCVEpSdlNtKzJBdHNYT3ZxWjNucE5wTHYzOE03MmxRdW1qaQpXaG9xdGgzWFpMSWFkcWxldDJiN2ZNaVZIM1pIRS9QaTNGd0tYZTJydXlCaWhaOUJvR1FyRmZXV3pwSmdzSTUyCnUwc3A1SW5QTW5VUEtGNG9sbHR6WVlaS0FCcjZtdlRwMnhrZmFpYzFDRGZDalN2UE9IVjRobHdIRStLTGVxMmYKbkYrOGNaTU54UkoxbjZ3V1Y2M3JoN2d0cEdUSXEzTUxNa1FKMmgxeFpad3RSbUJldDdOVEJrMUx4R2xBL3pZNAo4dzhzTCt0UHhReHZ6T2xITDQxTCt3WmdCNDJFNlpvNk1GSzBmNmxNWGk4eHI2REpoNS9pTFJ1NFdkRkphd3Z0ClFQY3paRVJBYm00NzV5V3Q0MjhwYmxtM3gzcWw5MkVDZ2dFQkFLQWdOdzhlL3RjczhiM0h3VWF3UXRqdjZ3ZXYKYlQ4YVl5S2hVRVVMajV0aTI2ZXkxeWdKc2hnaXhPcEFIT0Z4ZXIzUHpqRzRxcXphUmtaSWRIcUg4RzAxNndTegprMk5hVENrL0piaEY1a2x4NGwyQ0w0bG1SQnhMNmJWSGJpMWhFcmVEZk53LzR4bXhHWmoxWnlhSFRQang1RWFoCnBQdUx0ellmb29wc2E4QXNZZTJMdUgxbHZ3WWpUMnFRdjl6NFlDY1A1WW4wSzcyYUNHMzFzZ3Bqa21YM0xJQ1cKN1NoaXlrSDQ4ak94T2Z6aEs0MVIyWXFrVWI1bG1iQjc3K0M3cldKWERYNHZnaVVnMjB3eVpVVmE1dDE3N1BBQgpJWnRTTUU3anh1K3RpOHRKUE9KeUdGczBWQXFpb1RweWVaNUJtcDl6MFhjMWtyS1JvQXVTdk4rZktGWT0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K%"
  NEXT_PUBLIC_PUB_KEY_FAKE: "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQ0lqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FnOEFNSUlDQ2dLQ0FnRUF4M2kvZGpZdElEaW5WQ2ZmbG1TMApLYVdBSWUxNjFUUVlOeTFIbHJSampmOTNJSWJEU1F5eW5zSWwyS3VMMmVYenhmaFpMd21vTnc2U1BueDhrZy9QCnB4blJZNzYxUXhJeEJiTnZvcko3YWJZamYxYmptZ1RPbUgrYjUzbStoRExuYWExQ211SDJBSVFsMnJwSlpwT2IKWndFcC9LQStUWHdhMDlVOC8yaWJKZDdHM0l4RTBLYnpaRFZwdzh3VWhQanVNQUhBVWdDVnp2Ylh6ajN2MW16dQpOQklTcE5EVW1oZFk4dDNhTTA0S1dCY1hWcC92cXRBTXlFY1pVTXNpK1hKeFQ2ZFZoV2IzYnV4MkNOTlFlL0tiClMyekw1OHBnZnVqQmY4L0YyczN0WWQrWlh5YlFSWEMzRFIvM1RCa2NILzU0aXpURklUbUpDSXl4UkdZYjArT0MKWnpNeXRaUy93SXllRDZObjRvSjk3VUZUcGlGOGZHQTZlNy9lYTFLb3RaR0NVSUpQdFhMZ0w4Q0VNbEhwdE03Two1MmRZcmp6b3NSV20xK20zbDNrV09zTDdod08wWUNlZVpFLzRDcXBLZDVGZHNmNlFPQ0dWMXRkNlBnVXg1N3Y4CnRoM3Y5Y085VmRRTUkwT0MwOWRVc2VUdmN4bDI3MUZ3L0hnVTBJK0JrODdoT3FHT0cxb1VJMkNtNEFnQWplYnAKaUZnUW9pWGdHcjY5Mjlxb3lnUFlBT3I5RVBRWS91YUUrRnRJZVFsU0MrZlptNUdOMHpUazVlYWFBdW9kUHhPQgpGU2x1S3hja2xuMHFzbXF1aC9WR1FZVHBrRm9UR05McnZhbzc3UThhM3Q4TXVQOWJOY3ZZQXlWWEJBTVlyZnFDCnlqa1hCRzdZb1htUldtWCtaTFlGQy9VQ0F3RUFBUT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=%"
  NEXT_PUBLIC_PUB_KEY: "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlHZU1BMEdDU3FHU0liM0RRRUJBUVVBQTRHTUFEQ0JpQUtCZ0dBUlBWaG9hVWdNbHE1TkxaMTVPR3ZtVFBoVgpnTVhOb1R5cktPZWFmNWRpODBCZDVHKzFidHN2aG13MFJnbXJFanZZWHlnMGNtaGR5M3AyZTFvanNGd1RxazEwCjhPd0swVnRZL2tvV3B5eThZTklMMHdSd1Fha1FXZWQzdlhvVlhOWGg0VVQxd290UzZhS0tvV3BmRUYrNUY5UlYKcTVra1VHVzl1MlhWRXhJekFnTUJBQUU9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQ==%"

jobs:
  Build-Test-Image:
    if: github.event.pull_request.merged == true
    name: üê≥ Build Test Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build Test Docker Image
        run: docker build -t ${{ env.DOCKER_IMAGE_NAME_TEST }} -f Dockerfile .

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Push Docker Image to Docker Hub
        run: docker push ${{ env.DOCKER_IMAGE_NAME_TEST }}

  Tests:
    name: üß© Run Tests
    runs-on: ubuntu-latest
    needs: Build-Test-Image
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Pull Test Docker Image
        run: docker pull ${{ env.DOCKER_IMAGE_NAME_TEST }}

      - name: Run Tests in Docker Container
        run: docker run --rm ${{ env.DOCKER_IMAGE_NAME_TEST }} npm run test

  Push-Docker-Image:
    name: üê≥ Push Docker Image to Docker Hub
    needs: [Tests]
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Pull Test Docker Image
        run: docker pull ${{ env.DOCKER_IMAGE_NAME_TEST }}

      - name: Tag docker image to latest
        run: docker tag ${{ env.DOCKER_IMAGE_NAME_TEST }} ${{ env.DOCKER_IMAGE_NAME_LATEST }}

      - name: Push Docker Image to Docker Hub
        run: docker push ${{ env.DOCKER_IMAGE_NAME_LATEST }}

  Deploy-to-Kubernetes:
    name: Deploy to Kubernetes
    needs: [ Push-Docker-Image ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Pull Test Docker Image
        run: docker pull ${{ env.DOCKER_IMAGE_NAME_LATEST }}

#      - name: Helm job dev api
#        uses: WyriHaximus/github-action-helm3@v3
#        with:
#          exec: helm upgrade gameplay-api ./gameplay-api --install --wait --atomic --namespace=game-team --values=./gameplay-api/values.yaml
#          kubeconfig: ${{ secrets.KUBECONFIG }}
#
#      - name: Helm job dev db
#        uses: WyriHaximus/github-action-helm3@v3
#        with:
#          exec: helm upgrade gameplay-db ./gameplay-db --install --wait --atomic --namespace=game-team --values=./gameplay-db/values.yaml
#          kubeconfig: ${{ secrets.KUBECONFIG }}


      - name: Helm job integration api
        uses: WyriHaximus/github-action-helm3@v3
        with:
          exec: helm upgrade gameplay-api ./gameplay-api --install --wait --atomic --namespace=integration --values=./gameplay-api/values.yaml
          kubeconfig: ${{ secrets.KUBECONFIG }}


